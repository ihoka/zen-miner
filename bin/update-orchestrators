#!/bin/bash
# Deploy orchestrator updates to all hosts
# Usage: bin/update-orchestrators

set -e

echo "=========================================="
echo "Deploying Orchestrator Updates"
echo "=========================================="
echo ""

# Get list of hosts from Kamal config
HOSTS=$(kamal config | grep -A 10 "hosts:" | grep "^  -" | awk '{print $2}')

if [ -z "$HOSTS" ]; then
  echo "ERROR: No hosts found in Kamal config"
  exit 1
fi

echo "Updating orchestrators on:"
for host in $HOSTS; do
  echo "  - $host"
done
echo ""

read -p "Continue? (y/N) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
  echo "Aborted"
  exit 1
fi

# Deploy to each host via Kamal
for host in $HOSTS; do
  echo ""
  echo "===================="
  echo "Updating: $host"
  echo "===================="

  # Execute update script on host
  # Note: This runs in a container but the script has access to host via bind mounts
  kamal app exec --hosts "$host" 'bash /rails/host-daemon/update-orchestrator.sh' || {
    echo "✗ Failed to update $host"
    exit 1
  }

  echo "✓ $host updated successfully"
done

echo ""
echo "=========================================="
echo "All Orchestrators Updated!"
echo "=========================================="
