# Name of your application. Used to uniquely configure containers.
service: zen-miner

# Name of the container image.
# TODO: Replace with your Docker Hub username
image: ihoka/zen-miner

# Deploy to these servers (6 servers behind Cloudflare load balancing).
# TODO: Replace with actual server hostnames or IPs
servers:
  web:
    - mini-1
    - miner-beta
    - miner-gamma
    - miner-delta

# SSH configuration - use 'deploy' user instead of root
ssh:
  user: deploy

# Cloudflare proxy configuration.
# Cloudflare handles SSL termination, so ssl: false here.
# Set Cloudflare SSL/TLS mode to "Full" in your dashboard.
# Connection: Browser --[HTTPS]--> Cloudflare --[HTTP]--> Servers
#
# Requires config.assume_ssl = true and config.force_ssl = true in production.rb
#
# TODO: Replace with your production domain
proxy:
  ssl: false
  host: app.example.com
  healthcheck:
    path: /up
    interval: 3

# Container registry - Docker Hub.
# Credentials are fetched from 1Password/Bitwarden via .kamal/secrets
registry:
  server: docker.io
  username:
    - KAMAL_REGISTRY_USERNAME
  password:
    - KAMAL_REGISTRY_PASSWORD

# Environment variables injected into containers.
# Secrets are fetched from 1Password/Bitwarden at deploy time.
env:
  secret:
    - RAILS_MASTER_KEY
  clear:
    # Run Solid Queue in Puma process
    SOLID_QUEUE_IN_PUMA: true

    # Trust Cloudflare proxy headers
    RAILS_ASSUME_SSL: true

    # 2 Puma workers per server
    WEB_CONCURRENCY: 2

    # Production log level
    RAILS_LOG_LEVEL: info

# Kamal aliases for common operations.
aliases:
  console: app exec --interactive --reuse "bin/rails console"
  shell: app exec --interactive --reuse "bash"
  logs: app logs -f
  dbc: app exec --interactive --reuse "bin/rails dbconsole"

# Persistent storage for Active Storage uploads.
# Note: With 6 servers, consider using S3/R2 for Active Storage instead of local volumes.
volumes:
  - "zen-miner_storage:/rails/storage"

# Bridge fingerprinted assets between deployments to avoid 404s.
asset_path: /rails/public/assets

# Build configuration.
builder:
  arch: amd64
  # Uncomment for multi-platform builds (e.g., deploying to ARM servers)
  # multiarch: true
  #
  # Uncomment for faster amd64 builds on Apple Silicon
  # remote: ssh://docker@your-build-server
